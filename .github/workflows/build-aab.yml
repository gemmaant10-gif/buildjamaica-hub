name: Build & Sign AAB (Bubblewrap)

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  build-aab:
    name: Build AAB (TWA)
    runs-on: ubuntu-latest
    env:
      CI: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Set up Java (for Android build)
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Ensure Java on PATH
        run: |
          echo "JAVA_HOME=${{ steps.setup-java.outputs.path }}" >> $GITHUB_ENV
          echo "${{ steps.setup-java.outputs.path }}/bin" >> $GITHUB_PATH
          java -version
          javac -version

      - name: Install dependencies and build web assets
        run: |
          npm ci
          npm run build

      - name: Install Android SDK packages
        env:
          ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        run: |
          yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager \
            "platform-tools" "build-tools;33.0.2" "platforms;android-33"
          echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
          echo "/usr/local/lib/android/sdk/platform-tools" >> $GITHUB_PATH

      - name: Install Bubblewrap CLI
        run: npm install -g @bubblewrap/cli

      - name: Initialize TWA config (non-interactive)
        env:
          MANIFEST_URL: ${{ secrets.MANIFEST_URL }}
          PACKAGE_NAME: ${{ secrets.PACKAGE_NAME }}
          JAVA_HOME: ${{ steps.setup-java.outputs.path }}
        run: |
          export JAVA_HOME="${{ steps.setup-java.outputs.path }}"
          export PATH="$JAVA_HOME/bin:$PATH"
          # MANIFEST_URL and PACKAGE_NAME must be provided as repository secrets
          if [ -z "$MANIFEST_URL" ] || [ -z "$PACKAGE_NAME" ]; then
            echo "MANIFEST_URL or PACKAGE_NAME secret missing" >&2
            exit 1
          fi
          npx @bubblewrap/cli init --manifest="$MANIFEST_URL" --packageId="$PACKAGE_NAME" --no-interactive || true

      - name: Decode keystore (only if provided)
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 || '' }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 --decode > ./build.keystore
          else
            echo "No KEYSTORE_BASE64 secret provided; continuing without a keystore";
          fi

      - name: Build and sign AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          JAVA_HOME: ${{ steps.setup-java.outputs.path }}
        run: |
          export JAVA_HOME="${{ steps.setup-java.outputs.path }}"
          export PATH="$JAVA_HOME/bin:$PATH"
          BUBBLEWRAP_CMD="npx @bubblewrap/cli build"
          # If keystore is provided, pass signing args to bubblewrap. Bubblewrap may accept
          # --keystore, --keystorePassword, --keyAlias, --keyPassword. If flags differ between
          # versions, adjust locally or test the workflow. The command below is the common usage.
          if [ -f ./build.keystore ]; then
            printf 'n\n' | $BUBBLEWRAP_CMD -- --jdkPath="$JAVA_HOME" --keystore=./build.keystore --keystorePassword="$KEYSTORE_PASSWORD" --keyAlias="$KEY_ALIAS" --keyPassword="$KEY_PASSWORD"
          else
            # Attempt unsigned build (you'll need to sign later or use Play App Signing)
            printf 'n\n' | $BUBBLEWRAP_CMD -- --jdkPath="$JAVA_HOME"
          fi

      - name: Find produced AAB
        run: |
          echo "Looking for .aab files"
          find . -type f -name "*.aab" -maxdepth 6 || true

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-aab
          path: |
            **/*.aab
            android/build/outputs/**/*.aab
